# Release Checklist for Themis v0.2.1

**Release Type:** Critical Bug Fix  
**Release Date:** 2026-01-24  
**Status:** Ready for Release âœ…

---

## Pre-Release Verification

### âœ… Version & Metadata
- [x] Version bumped to 0.2.1 in `pyproject.toml`
- [x] Version fallback updated to 0.2.1 in `themis/_version.py`
- [x] CHANGELOG.md updated with v0.2.1 release notes
- [x] Release date added to CHANGELOG.md

### âœ… Critical Bug Fixes
- [x] **Deadlock bug fixed** - Non-reentrant file locks causing evaluation to hang
- [x] **Provider registration fixed** - Missing imports in themis/api.py
- [x] **OS compatibility improved** - Unix/Linux/macOS/Windows/fallback support

### âœ… Testing
- [x] New test suite added: `tests/experiment/test_reentrant_locks.py` (12 tests)
- [x] All core tests passing: 28 passed, 1 skipped
- [x] API tests passing: 16/16 tests
- [x] No linter errors
- [x] Production test verified with real vLLM server (5 samples/sec)

### âœ… Code Quality
- [x] No linter errors (Ruff clean)
- [x] Type hints maintained
- [x] Comprehensive docstrings added
- [x] Code follows project conventions

### âœ… Documentation
- [x] CHANGELOG.md updated with detailed v0.2.1 changes
- [x] All temporary debug files removed
- [x] Code comments updated for new lock implementation
- [x] No breaking changes

### âœ… Performance
- [x] Evaluation completes successfully (was hanging forever)
- [x] 20 samples in 4.0s = 5 samples/sec throughput
- [x] No performance regressions

---

## Release Steps

### 1. Verify Version Numbers
```bash
# Check version is 0.2.1
grep "version = " pyproject.toml
grep "return " themis/_version.py
```

### 2. Run Full Test Suite
```bash
# Core API tests
uv run pytest tests/api/test_evaluate.py -v

# New reentrant lock tests
uv run pytest tests/experiment/test_reentrant_locks.py -v

# Storage tests
uv run pytest tests/experiment/test_storage.py -v

# Quick smoke test
uv run python -m themis.cli demo
```

### 3. Build and Verify Package
```bash
# Clean previous builds
rm -rf dist/ build/ *.egg-info

# Build package
uv build

# Verify package
uv run twine check dist/*
```

### 4. Test Installation Locally
```bash
# Create clean venv
python -m venv /tmp/test-themis-0.2.1
source /tmp/test-themis-0.2.1/bin/activate

# Install from dist
pip install dist/themis_eval-0.2.1-py3-none-any.whl

# Test import
python -c "import themis; print(f'Version: {themis.__version__}')"

# Test basic functionality
python -c "from themis import evaluate; print('Import successful!')"

# Cleanup
deactivate
rm -rf /tmp/test-themis-0.2.1
```

### 5. Git Operations
```bash
# Stage version changes
git add pyproject.toml themis/_version.py .release-checklist-v0.2.1.md

# Commit version bump
git commit -m "Bump version to 0.2.1"

# Create annotated tag
git tag -a v0.2.1 -m "Release v0.2.1 - Critical deadlock fix

Critical Fixes:
- Fix non-reentrant file locks causing evaluation to hang
- Fix provider registration in themis.api.evaluate()
- Improve OS compatibility (Unix/Linux/macOS/Windows/fallback)

Improvements:
- Add 12 comprehensive tests for reentrant locks
- Add enhanced logging throughout codebase
- Add 30-second timeout for stale locks
- Improve error messages with context and hints

Performance:
- Evaluation now completes in ~4s for 20 samples (was hanging forever)
- Throughput: 5 samples/sec with 8 workers

Tests: 28 passed, 0 failures
"

# Verify tag
git tag -n99 v0.2.1

# Push commits and tag
git push origin main
git push origin v0.2.1
```

### 6. Publish to PyPI
```bash
# Test PyPI first (optional)
# uv publish --repository testpypi

# Production PyPI
uv publish

# Verify on PyPI
# Visit: https://pypi.org/project/themis-eval/
```

### 7. Create GitHub Release
1. Go to https://github.com/Pittawat2542/themis/releases/new
2. Select tag: `v0.2.1`
3. Title: **"Themis v0.2.1 - Critical Deadlock Fix"**
4. Description:
```markdown
## ðŸš¨ Critical Bug Fix Release

This release fixes a critical deadlock bug that caused `themis.evaluate()` to hang indefinitely.

### Critical Fixes
- **Fixed:** Non-reentrant file locks causing evaluation to hang forever
- **Fixed:** Provider registration issue in `themis.api.evaluate()`
- **Improved:** OS compatibility for Unix/Linux/macOS/Windows

### Improvements
- Added 12 comprehensive tests to prevent regression
- Enhanced logging throughout codebase
- Better error messages with helpful hints
- 30-second timeout for stale locks

### Performance
- Evaluation now completes successfully (was hanging forever)
- Throughput: 5 samples/sec with 8 workers on real vLLM server

### Breaking Changes
None - this is a drop-in replacement for v0.2.0.

### Upgrade
```bash
pip install --upgrade themis-eval
```

**Full Changelog:** https://github.com/Pittawat2542/themis/compare/v0.2.0...v0.2.1

See [CHANGELOG.md](https://github.com/Pittawat2542/themis/blob/main/CHANGELOG.md) for detailed changes.
```
5. Publish release

### 8. Post-Release Verification
```bash
# Wait 5-10 minutes for PyPI to propagate

# Test fresh install
pip install --upgrade themis-eval

# Verify version
python -c "import themis; print(themis.__version__)"
# Should print: 0.2.1

# Test basic functionality
python -c "from themis.api import evaluate; print('âœ… Import successful!')"
```

---

## Test Results

### Unit Tests
```
tests/api/test_evaluate.py ................              [16/16] âœ…
tests/experiment/test_reentrant_locks.py ............s   [12/13] âœ…
Total: 28 passed, 1 skipped
```

### Linter
```
ruff check themis/ tests/
âœ… No errors
```

### Production Test
```python
# Real vLLM server at localhost:9876
report = evaluate(
    dataset=[...],  # 20 samples
    model="openai/pittawat/rl-scaling-sft-qwen-2.5-7b-instruct",
    api_base="http://localhost:9876/v1",
    api_key="dummy",
    workers=8,
)
# âœ… Completed in 4.0s (5 samples/sec)
```

---

## What's Fixed in v0.2.1

### The Deadlock Bug
**Problem:** Evaluation hung forever after generation completed.

**Root Cause:** Non-reentrant file locks - when the same process tried to acquire the lock twice (e.g., `start_run()` then `append_record()`), it would deadlock.

**Solution:** Made locks reentrant with reference counting:
- Track lock count per `run_id`
- Only release OS lock when count reaches 0
- Added timeout and better error messages

**Impact:** Evaluation now works correctly!

### Files Changed
- `themis/experiment/storage.py` - Reentrant lock implementation
- `themis/api.py` - Provider registration + logging
- `themis/experiment/orchestrator.py` - Progress logging
- `themis/generation/runner.py` - Execution logging
- `themis/generation/providers/litellm_provider.py` - Error handling
- `tests/experiment/test_reentrant_locks.py` - New test suite
- `CHANGELOG.md` - Release notes

**Total:** 8 files, ~400 lines production code, 320 lines tests

---

## Known Issues
None! All critical issues have been resolved.

---

## Migration from v0.2.0

**No migration needed!** This is a drop-in replacement.

Just upgrade:
```bash
pip install --upgrade themis-eval
```

If you had stale lock files from hung processes:
```bash
# Optional cleanup
find .cache -name ".lock" -delete
```

---

## Rollback Plan

If critical issues are discovered:

```bash
# Yank the release
twine upload --skip-existing  # Don't overwrite
pip install themis-eval==0.2.0  # Users can downgrade

# Fix issues, bump to 0.2.2
# Update pyproject.toml, CHANGELOG.md
# Follow release process again
```

---

## Sign-Off Checklist

- [x] All tests passing (28 passed, 0 failures)
- [x] No linter errors
- [x] Version bumped to 0.2.1
- [x] CHANGELOG.md updated
- [x] Production test successful (5 samples/sec)
- [x] No breaking changes
- [x] Documentation clean (no temp files)
- [x] Commits created and messages clear
- [x] Ready to tag and release

**Ready for release:** âœ… **YES**

**Release Manager:** Pittawat Taveekitworachai  
**Release Date:** 2026-01-24  
**Release Type:** Critical Bug Fix
