name: CI

on:
  push:
    branches: [main, develop]
    tags:
      - "v*.*.*"
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  PYTHONUNBUFFERED: "1"

jobs:
  quality:
    name: Quality Gates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --frozen --all-extras --dev

      - name: Detect changed Python files
        id: changed-python
        shell: bash
        run: |
          if [[ "${{ github.ref_type }}" == "tag" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            : > changed_python_files.txt
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"

            if [[ -z "${BASE_SHA}" || "${BASE_SHA}" == "0000000000000000000000000000000000000000" ]]; then
              git ls-files '*.py' > changed_python_files.txt
            else
              git diff --name-only --diff-filter=ACMRT "${BASE_SHA}" "${{ github.sha }}" -- '*.py' > changed_python_files.txt
            fi
          fi

          COUNT="$(wc -l < changed_python_files.txt | tr -d ' ')"
          echo "count=${COUNT}" >> "$GITHUB_OUTPUT"
          echo "Detected ${COUNT} changed Python files"

      - name: Check formatting on changed Python files
        if: steps.changed-python.outputs.count != '0'
        shell: bash
        run: |
          mapfile -t changed_files < changed_python_files.txt
          uv run ruff format --check "${changed_files[@]}"

      - name: Run lint on changed Python files
        if: steps.changed-python.outputs.count != '0'
        shell: bash
        run: |
          mapfile -t changed_files < changed_python_files.txt
          uv run ruff check "${changed_files[@]}"

      - name: Run baseline lint (syntax/runtime safety)
        run: uv run ruff check --select E9,F63,F7 themis tests

  tests:
    name: Tests (Python ${{ matrix.python-version }})
    needs: quality
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --frozen --all-extras --dev

      - name: Run test suite
        run: uv run pytest -q

  coverage:
    name: Coverage
    needs: quality
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --frozen --all-extras --dev

      - name: Run coverage
        run: uv run pytest -q --cov=themis --cov-report=xml --cov-fail-under=60

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v6
        with:
          name: coverage-xml
          path: coverage.xml

  docs-build:
    name: Build Documentation
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --frozen --all-extras --dev

      - name: Build documentation (strict)
        run: uv run mkdocs build --strict

  package:
    name: Build Package
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build package
        run: uv build

      - name: Validate package metadata
        run: uvx --from twine twine check dist/*

      - name: Upload package artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist/

  dependency-review:
    name: Dependency Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
      - name: Dependency vulnerability review
        uses: actions/dependency-review-action@v4

  release-compatibility:
    name: Release Compatibility Matrix
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [quality, tests, docs-build, package]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.12"]
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --frozen --all-extras --dev

      - name: Run test suite
        run: uv run pytest -q
